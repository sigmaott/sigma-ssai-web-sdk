import{l as se,m as X,r as S,n as oe,p as ie}from"./zoid-bW7f30cY.js";const ae=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,ce=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,ue=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/;function le(e,r){if(e==="__proto__"||e==="constructor"&&r&&typeof r=="object"&&"prototype"in r){fe(e);return}return r}function fe(e){console.warn(`[destr] Dropping "${e}" key to prevent prototype pollution.`)}function H(e,r={}){if(typeof e!="string")return e;const n=e.trim();if(e[0]==='"'&&e.endsWith('"')&&!e.includes("\\"))return n.slice(1,-1);if(n.length<=9){const s=n.toLowerCase();if(s==="true")return!0;if(s==="false")return!1;if(s==="undefined")return;if(s==="null")return null;if(s==="nan")return Number.NaN;if(s==="infinity")return Number.POSITIVE_INFINITY;if(s==="-infinity")return Number.NEGATIVE_INFINITY}if(!ue.test(e)){if(r.strict)throw new SyntaxError("[destr] Invalid JSON");return e}try{if(ae.test(e)||ce.test(e)){if(r.strict)throw new Error("[destr] Possible prototype pollution");return JSON.parse(e,le)}return JSON.parse(e)}catch(s){if(r.strict)throw s;return e}}class de extends Error{constructor(r,n){super(r,n),this.name="FetchError",n!=null&&n.cause&&!this.cause&&(this.cause=n.cause)}}function pe(e){var p,i,t,h,c;const r=((p=e.error)==null?void 0:p.message)||((i=e.error)==null?void 0:i.toString())||"",n=((t=e.request)==null?void 0:t.method)||((h=e.options)==null?void 0:h.method)||"GET",s=((c=e.request)==null?void 0:c.url)||String(e.request)||"/",o=`[${n}] ${JSON.stringify(s)}`,f=e.response?`${e.response.status} ${e.response.statusText}`:"<no response>",l=`${o}: ${f}${r?` ${r}`:""}`,a=new de(l,e.error?{cause:e.error}:void 0);for(const u of["request","options","response"])Object.defineProperty(a,u,{get(){return e[u]}});for(const[u,w]of[["data","_data"],["status","status"],["statusCode","status"],["statusText","statusText"],["statusMessage","statusText"]])Object.defineProperty(a,u,{get(){return e.response&&e.response[w]}});return a}const me=new Set(Object.freeze(["PATCH","POST","PUT","DELETE"]));function D(e="GET"){return me.has(e.toUpperCase())}function he(e){if(e===void 0)return!1;const r=typeof e;return r==="string"||r==="number"||r==="boolean"||r===null?!0:r!=="object"?!1:Array.isArray(e)?!0:e.buffer?!1:e.constructor&&e.constructor.name==="Object"||typeof e.toJSON=="function"}const ge=new Set(["image/svg","application/xml","application/xhtml","application/html"]),ye=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function we(e=""){if(!e)return"json";const r=e.split(";").shift()||"";return ye.test(r)?"json":ge.has(r)||r.startsWith("text/")?"text":"blob"}function Te(e,r,n=globalThis.Headers){const s={...r,...e};if(r!=null&&r.params&&(e!=null&&e.params)&&(s.params={...r==null?void 0:r.params,...e==null?void 0:e.params}),r!=null&&r.query&&(e!=null&&e.query)&&(s.query={...r==null?void 0:r.query,...e==null?void 0:e.query}),r!=null&&r.headers&&(e!=null&&e.headers)){s.headers=new n((r==null?void 0:r.headers)||{});for(const[o,f]of new n((e==null?void 0:e.headers)||{}))s.headers.set(o,f)}return s}const Ee=new Set([408,409,425,429,500,502,503,504]),ve=new Set([101,204,205,304]);function K(e={}){const{fetch:r=globalThis.fetch,Headers:n=globalThis.Headers,AbortController:s=globalThis.AbortController}=e;async function o(a){const p=a.error&&a.error.name==="AbortError"&&!a.options.timeout||!1;if(a.options.retry!==!1&&!p){let t;typeof a.options.retry=="number"?t=a.options.retry:t=D(a.options.method)?0:1;const h=a.response&&a.response.status||500;if(t>0&&(Array.isArray(a.options.retryStatusCodes)?a.options.retryStatusCodes.includes(h):Ee.has(h))){const c=a.options.retryDelay||0;return c>0&&await new Promise(u=>setTimeout(u,c)),f(a.request,{...a.options,retry:t-1})}}const i=pe(a);throw Error.captureStackTrace&&Error.captureStackTrace(i,f),i}const f=async function(p,i={}){var u;const t={request:p,options:Te(i,e.defaults,n),response:void 0,error:void 0};t.options.method=(u=t.options.method)==null?void 0:u.toUpperCase(),t.options.onRequest&&await t.options.onRequest(t),typeof t.request=="string"&&(t.options.baseURL&&(t.request=se(t.request,t.options.baseURL)),(t.options.query||t.options.params)&&(t.request=X(t.request,{...t.options.params,...t.options.query}))),t.options.body&&D(t.options.method)&&(he(t.options.body)?(t.options.body=typeof t.options.body=="string"?t.options.body:JSON.stringify(t.options.body),t.options.headers=new n(t.options.headers||{}),t.options.headers.has("content-type")||t.options.headers.set("content-type","application/json"),t.options.headers.has("accept")||t.options.headers.set("accept","application/json")):("pipeTo"in t.options.body&&typeof t.options.body.pipeTo=="function"||typeof t.options.body.pipe=="function")&&("duplex"in t.options||(t.options.duplex="half")));let h;if(!t.options.signal&&t.options.timeout){const w=new s;h=setTimeout(()=>w.abort(),t.options.timeout),t.options.signal=w.signal}try{t.response=await r(t.request,t.options)}catch(w){return t.error=w,t.options.onRequestError&&await t.options.onRequestError(t),await o(t)}finally{h&&clearTimeout(h)}if(t.response.body&&!ve.has(t.response.status)&&t.options.method!=="HEAD"){const w=(t.options.parseResponse?"json":t.options.responseType)||we(t.response.headers.get("content-type")||"");switch(w){case"json":{const F=await t.response.text(),_=t.options.parseResponse||H;t.response._data=_(F);break}case"stream":{t.response._data=t.response.body;break}default:t.response._data=await t.response[w]()}}return t.options.onResponse&&await t.options.onResponse(t),!t.options.ignoreResponseError&&t.response.status>=400&&t.response.status<600?(t.options.onResponseError&&await t.options.onResponseError(t),await o(t)):t.response},l=async function(p,i){return(await f(p,i))._data};return l.raw=f,l.native=(...a)=>r(...a),l.create=(a={})=>K({...e,defaults:{...e.defaults,...a}}),l}const P=function(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")}(),be=P.fetch||(()=>Promise.reject(new Error("[ofetch] global.fetch is not supported!"))),ke=P.Headers,Re=P.AbortController,Oe=K({fetch:be,Headers:ke,AbortController:Re}),Se=Oe.create({credentials:"omit",onResponseError({response:e,error:r}){console.log("[LOG] ~ error:",r)},onRequest:({options:e,request:r})=>{const n=e.token;n&&(e.headers=e.headers||{},e.headers.Authorization=`${n}`)},onResponse({response:e,options:r}){}}),_e=e=>(r,n)=>(e.set(r,n),n),W=Number.MAX_SAFE_INTEGER===void 0?9007199254740991:Number.MAX_SAFE_INTEGER,V=536870912,U=V*2,Me=(e,r)=>n=>{const s=r.get(n);let o=s===void 0?n.size:s<U?s+1:0;if(!n.has(o))return e(n,o);if(n.size<V){for(;n.has(o);)o=Math.floor(Math.random()*U);return e(n,o)}if(n.size>W)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;n.has(o);)o=Math.floor(Math.random()*W);return e(n,o)},Y=new WeakMap,Fe=_e(Y),L=Me(Fe,Y),Ae=e=>e.method!==void 0&&e.method==="call",Ne=e=>typeof e.id=="number"&&typeof e.result=="boolean",Ce=e=>{const r=new Map([[0,()=>{}]]),n=new Map([[0,()=>{}]]),s=new Map,o=new Worker(e);return o.addEventListener("message",({data:i})=>{if(Ae(i)){const{params:{timerId:t,timerType:h}}=i;if(h==="interval"){const c=r.get(t);if(typeof c===void 0)throw new Error("The timer is in an undefined state.");if(typeof c=="number"){const u=s.get(c);if(u===void 0||u.timerId!==t||u.timerType!==h)throw new Error("The timer is in an undefined state.")}else typeof c=="function"&&c()}else if(h==="timeout"){const c=n.get(t);if(typeof c===void 0)throw new Error("The timer is in an undefined state.");if(typeof c=="number"){const u=s.get(c);if(u===void 0||u.timerId!==t||u.timerType!==h)throw new Error("The timer is in an undefined state.")}else typeof c=="function"&&(c(),n.delete(t))}}else if(Ne(i)){const{id:t}=i,h=s.get(t);if(h===void 0)throw new Error("The timer is in an undefined state.");const{timerId:c,timerType:u}=h;s.delete(t),u==="interval"?r.delete(c):n.delete(c)}else{const{error:{message:t}}=i;throw new Error(t)}}),{clearInterval:i=>{if(typeof r.get(i)=="function"){const t=L(s);s.set(t,{timerId:i,timerType:"interval"}),r.set(i,t),o.postMessage({id:t,method:"clear",params:{timerId:i,timerType:"interval"}})}},clearTimeout:i=>{if(typeof n.get(i)=="function"){const t=L(s);s.set(t,{timerId:i,timerType:"timeout"}),n.set(i,t),o.postMessage({id:t,method:"clear",params:{timerId:i,timerType:"timeout"}})}},setInterval:(i,t=0,...h)=>{const c=L(r);return r.set(c,()=>{i(...h),typeof r.get(c)=="function"&&o.postMessage({id:null,method:"set",params:{delay:t,now:performance.timeOrigin+performance.now(),timerId:c,timerType:"interval"}})}),o.postMessage({id:null,method:"set",params:{delay:t,now:performance.timeOrigin+performance.now(),timerId:c,timerType:"interval"}}),c},setTimeout:(i,t=0,...h)=>{const c=L(n);return n.set(c,()=>i(...h)),o.postMessage({id:null,method:"set",params:{delay:t,now:performance.timeOrigin+performance.now(),timerId:c,timerType:"timeout"}}),c}}},Ie=(e,r)=>{let n=null;return()=>{if(n!==null)return n;const s=new Blob([r],{type:"application/javascript; charset=utf-8"}),o=URL.createObjectURL(s);return n=e(o),setTimeout(()=>URL.revokeObjectURL(o)),n}},Le=`(()=>{"use strict";const e=new Map,t=new Map,r=t=>{const r=e.get(t);return void 0!==r&&(clearTimeout(r),e.delete(t),!0)},s=e=>{const r=t.get(e);return void 0!==r&&(clearTimeout(r),t.delete(e),!0)},o=(e,t)=>{const r=performance.now(),s=e+t-r-performance.timeOrigin;return{expected:r+s,remainingDelay:s}},i=(e,t,r,s)=>{const o=r-performance.now();o>0?e.set(t,setTimeout(i,o,e,t,r,s)):(e.delete(t),postMessage({id:null,method:"call",params:{timerId:t,timerType:s}}))};addEventListener("message",(n=>{let{data:a}=n;try{if("clear"===a.method){const{id:e,params:{timerId:t,timerType:o}}=a;if("interval"===o)postMessage({id:e,result:r(t)});else{if("timeout"!==o)throw new Error('The given type "'.concat(o,'" is not supported'));postMessage({id:e,result:s(t)})}}else{if("set"!==a.method)throw new Error('The given method "'.concat(a.method,'" is not supported'));{const{params:{delay:r,now:s,timerId:n,timerType:m}}=a;if("interval"===m)((t,r,s)=>{const{expected:n,remainingDelay:a}=o(t,s);e.set(r,setTimeout(i,a,e,r,n,"interval"))})(r,n,s);else{if("timeout"!==m)throw new Error('The given type "'.concat(m,'" is not supported'));((e,r,s)=>{const{expected:n,remainingDelay:a}=o(e,s);t.set(r,setTimeout(i,a,t,r,n,"timeout"))})(r,n,s)}}}}catch(e){postMessage({error:{message:e.message},id:a.id,result:null})}}))})();`,x=Ie(Ce,Le),qe=e=>x().clearTimeout(e),B=(...e)=>x().setTimeout(...e);function He(){const e=new Set,r=o=>{e.delete(o)};return{on:o=>(e.add(o),{off:()=>r(o)}),off:r,trigger:(...o)=>Promise.all(Array.from(e).map(f=>f(...o)))}}async function Pe(e){try{return{data:await e,error:null}}catch(r){return{data:null,error:r||{message:"Unknown error"}}}}function je(e){return new Promise((r,n)=>{const s=document.createElement("script");s.async=!0,s.src=e,s.onload=r,s.onerror=n,document.body.appendChild(s)})}const $e="https://cdn.jsdelivr.net/gh/sigmaott/sigma-ssai-web-sdk/v5/build/dist/wasm_exec.js";let N=null;function J(){N=null}function Ge(){const e=window;return e.Go?Promise.resolve(e.wasm):N||(N=je($e).then(()=>e.Go),N.then(J).catch(J),N)}class C{constructor(){return C.instance?C.instance:(this.session=null,this.go=null,this.buffer=null,this.audioMediaSequence={},C.instance=this,this)}async init(r){if(!this.buffer){const s=await(await fetch(r)).arrayBuffer();this.buffer=s}return C.instance}async loadSource(r){this.session&&(r.session=this.session);const n=JSON.stringify(r),s=new Go,o=await WebAssembly.instantiate(this.buffer,s.importObject);s.run(o.instance);let f;for(let l=1;l<=3;l++)try{f=await window.loadSource(n);break}catch(a){if(console.log(`Attempt ${l} failed:`,a),l===3)throw console.log("session:",this.session),console.log(n),a}if(f.session!=""&&(this.session=f.session),f.error)throw new Error(f.error);return f.manifest}async getEventTracking(){if(this.session){const r=window.getEventTracking(this.session);if(r.error)throw new Error(r.error);return{avails:JSON.parse(r.avails)}}return null}}const Q=S(),Z=S();function z({adsUrl:e,sdk:r,loader:n}){return class extends n{constructor(o){super(o)}load(o,f,l){const a=l.onSuccess;l.onSuccess=async(p,i,t)=>{(t.type==="manifest"||t.type==="level"||t.type==="audioTrack")&&(p.data=await this.modifyManifest(p.url,p.data,t.type)),a(p,i,t)},super.load(o,f,l)}async modifyManifest(o,f,l){console.log("[LOG] ~ manifest:",f),Q.value=f;const a={proxyAds:{uri:e,timeout:2}};try{const p=await r.loadSource({config:a,manifest:f,masterUri:o});return console.log("[LOG] ~ newManifest:",p),Z.value=p,p}catch(p){return console.error("[LOG] ~ error:",p),f}}}}function De({video:e,adContainer:r,startSession:n,sdk:s}){const o=He(),f=S(!1),l=S(),a=Math.random().toString(36).slice(6);function p({icons:g}){return{id:a,appConfig:{sdkBaseUrl:X("https://cdn.jsdelivr.net/gh/sigmaott/sigma-ssai-web-sdk/v5/build/dist/wta/index.html",{id:a})},icons:g}}const i=oe(p({icons:[]}));i.render(r),i.hide(),r.style.display="none",ie(()=>{var g;if(l.value){const d=((g=l.value)==null?void 0:g.icons)||[];r.style.display="block",i.updateProps(p({icons:d})),i.show()}else r.style.display="none",i.hide()});const t=S([]),h=S(),c=S([]);async function u(g){var m;console.log("[LOG] ~ currentAd:",l);const d=(m=l.value)==null?void 0:m.trackingEvents.find(v=>v.eventType===g);if(!d){console.debug("[LOG] ~ event:",g);return}o.trigger(d),await Promise.all(d.beaconUrls.map(v=>Pe(Se(v))))}const w=new Map;let F;function _(g,d,m){g.addEventListener(d,m),w.set(d,m)}function y(){return f.value=!1,["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","msfullscreenchange"].forEach(g=>{_(e,g,()=>{const d=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;u(d?"fullscreen":"exitFullscreen")})}),_(e,"pause",()=>u("pause")),_(e,"play",()=>u("resume")),_(e,"rewind",()=>u("rewind")),_(e,"mute",()=>u("mute")),_(e,"unmute",()=>u("unmute")),async(g,d)=>{var R,M;if(h.value=d.frag.sn,g!==window.Hls.Events.FRAG_CHANGED)return;const m=t.value.find(O=>O.sn===d.frag.sn);if(!m)return;const v=(R=m==null?void 0:m.value)==null?void 0:R.event,b=c.value.find(O=>O.eventType===v&&!O.tracked);if(!b)return;const T=b==null?void 0:b.ad;if(T){if(v==="start")l.value&&console.debug("[LOG] ~ currentAd:",l.value),l.value=T,n(T.adVerifications,o),F=B(async()=>{u("impression"),u("start");const O=c.value.find(j=>j.key===b.key.replace("_start","_impression"));O&&(O.tracked=!0),b.tracked=!0},m.time*1e3);else{if(T.id!==((M=l.value)==null?void 0:M.id)){console.debug("[LOG] ~ ad:",T),console.debug("[LOG] ~ currentAd:",l.value);return}F=B(async()=>{u(v),v==="complete"&&(l.value=void 0),b.tracked=!0},m.time*1e3)}t.value=t.value.filter(O=>O.sn!==d.frag.sn)}}}async function k(){return s.getEventTracking().then(g=>{for(const d of(g==null?void 0:g.avails)||[])for(const m of d.ads){const v=`${d.id}_${m.id}_${m.startTimeInSeconds}`;for(const b of m.trackingEvents){const T=`${v}_${b.eventType}`;c.value.find(M=>M.key===T)||c.value.push({...b,key:T,ad:{...m,key:v},tracked:!1})}}})}function I(){return async(g,d)=>{function m(T){for(let R=0;R<T.length;R++)if(T[R]===0)return R;return T.length}const{start:v,sn:b}=d.frag;for(let T=0;T<d.samples.length;T++){const R=d.samples[T],M=R.data,O=R.pts;if(String.fromCharCode.apply(null,M.slice(0,3))!=="ID3"||String.fromCharCode.apply(null,M.slice(10,14))!=="TXXX")continue;const q=M.slice(21,M.length),te=m(q),$=q.slice(te+1,q.length),re=m($),ne=new TextDecoder("utf-8").decode($.slice(0,re)),G={sn:b,time:O-v,value:H(ne)};if(h.value&&b<h.value)return;t.value.push(G),G.value.event==="start"&&k()}}}function A(){return g=>{const d=g.track;d.kind==="metadata"&&d.on("cuechange",async()=>{const m=d.activeCues[0];m&&m.value.data&&(await k(),H(m.value.data))})}}function E(g,d){o.on(m=>{(g==="*"||m.eventType===g)&&d(m)})}function ee(){l.value=void 0,t.value=[],w.forEach((g,d)=>{e.removeEventListener(d,g)}),w.clear(),qe(F)}return{destroy:ee,onEventTracking:E,hlsHelper:{createHlsFragChanged:y,createHlsFragParsingMetadata:I},videojsHelper:{createVideojsAddTrack:A}}}async function Je({video:e,adContainer:r,adsUrl:n}){await Ge();const s=new C;await s.init("https://cdn.jsdelivr.net/gh/sigmaott/sigma-ssai-web-sdk/v5/build/dist/sigma-cspm.wasm");function o(){}const{onEventTracking:f,destroy:l,videojsHelper:a,hlsHelper:p}=De({video:e,adContainer:r,trackingUrl:"",startSession:o,sdk:s}),i=S(),t=S();function h(y){y.config.loader=z({adsUrl:n,sdk:s,loader:Hls.DefaultConfig.loader}),i.value=y;const k=p.createHlsFragChanged(),I=p.createHlsFragParsingMetadata();y.on("hlsFragChanged",k),y.on("hlsFragParsingMetadata",I),y.on(Hls.Events.ERROR,(A,E)=>{console.error("HLS Error:",A,E),E.type===window.Hls.ErrorTypes.NETWORK_ERROR?console.error("Network Error:",E.details):E.type===window.Hls.ErrorTypes.MEDIA_ERROR?console.error("Media Error:",E.details):console.error("Other Error:",E.details)}),t.value=()=>{y.destroy()}}function c(y){console.debug("[LOG] ~ SigmaManager.DefaultConfig.loader:",SigmaManager.DefaultConfig.loader),y.hls.config.loader=z({adsUrl:n,sdk:s,loader:SigmaManager.DefaultConfig.loader}),i.value=y.hls;const k=p.createHlsFragChanged(),I=p.createHlsFragParsingMetadata();y.hls.on("hlsFragChanged",k),y.hls.on("hlsFragParsingMetadata",I),y.on(SigmaManager.Events.ERROR,(A,E)=>{console.log("[LOG] ~ event:",A),console.debug("[LOG] ~ _modifiedManifest:",Z.value),console.debug("[LOG] ~ _manifest:",Q.value),console.error("HLS Error:",A,E),E.type===window.Hls.ErrorTypes.NETWORK_ERROR?console.error("Network Error:",E.details):E.type===window.Hls.ErrorTypes.MEDIA_ERROR?console.error("Media Error:",E.details):console.error("Other Error:",E.details)}),t.value=()=>{y.hls.destroy()}}const u=S(),w=S();function F(y){u.value=y;const k=a.createVideojsAddTrack();y.textTracks().on("addtrack",k),w.value=()=>{y.textTracks().off("addtrack",k)}}function _(){var y,k;l(),(y=t.value)==null||y.call(t),(k=w.value)==null||k.call(w),i.value=null,u.value=null,t.value=null,w.value=null}return{onEventTracking:f,destroy:_,sigmaPlayer:{attachVideojs:F,attachHls:h,attachSigmaDrm:c},sdk:s}}const ze=(e,r)=>{const n=e.__vccOpts||e;for(const[s,o]of r)n[s]=o;return n};export{ze as _,Je as c,je as l};
